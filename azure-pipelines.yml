trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  AWS_REGION: af-south-1
  LAMBDA_FUNCTION_NAME: sample-azuredevops-lambda

steps:
- checkout: self

# =====================================
# 1️⃣ Package Lambda code
# =====================================
- script: |
    set -e
    cd lambda
    zip -r function.zip .
  displayName: Package Lambda code

# =====================================
# 2️⃣ Deploy to AWS Lambda
# =====================================
- task: AWSShellScript@1
  displayName: Deploy Lambda Function
  inputs:
    awsCredentials: aws-lambda-connection   # ✅ Dedicated Lambda service connection
    regionName: $(AWS_REGION)
    scriptType: inline
    inlineScript: |
      set -e

      echo "Validating AWS identity"
      aws sts get-caller-identity

      echo "Updating Lambda function code"
      aws lambda update-function-code \
        --function-name $(LAMBDA_FUNCTION_NAME) \
        --zip-file fileb://lambda/function.zip

      echo "Publishing new Lambda version"
      aws lambda publish-version \
        --function-name $(LAMBDA_FUNCTION_NAME)
